<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bus Search</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>

<style>
body{
  background:#f4f6f9;
  min-height:100vh;
}
.search-card{
  max-width:520px;
  border-radius:16px;
  background:#fff;
  border:1px solid #e9ecef;
}
.input-box{
  position:relative;
}
.options{
  position:absolute;
  width:100%;
  max-height:160px;
  overflow:auto;
  background:#fff;
  border:1px solid #dee2e6;
  border-radius:12px;
  margin-top:4px;
  z-index:10;
}
.options div{
  padding:8px 12px;
  cursor:pointer;
}
.options div:hover{
  background:#f1f3f5;
}
.notfound{
  font-size:13px;
  color:#dc3545;
}
#phaser-bg{
  position:fixed;
  inset:0;
  z-index:-1;
}
</style>
</head>

<body>
<div id="phaser-bg"></div>

<div id="app" class="container py-5">
  <h3 class="text-center fw-bold mb-4">Search Bus</h3>

  <div class="search-card p-4 mx-auto">

    <!-- FROM -->
    <div class="mb-3 input-box">
      <label class="form-label">From</label>
      <input class="form-control"
        v-model="from"
        @input="filterStops('from')"
        placeholder="Starting point">
      <div class="options" v-if="showFromOptions">
        <div v-for="s in filteredStops" @click="selectStop('from',s)">
          {{s}}
        </div>
      </div>
      <div class="notfound" v-if="fromNotFound">Not found, try another</div>
    </div>

    <!-- TO -->
    <div class="mb-3 input-box">
      <label class="form-label">To</label>
      <input class="form-control"
        v-model="to"
        @input="filterStops('to')"
        placeholder="Destination">
      <div class="options" v-if="showToOptions">
        <div v-for="s in filteredStops" @click="selectStop('to',s)">
          {{s}}
        </div>
      </div>
      <div class="notfound" v-if="toNotFound">Not found, try another</div>
    </div>

    <!-- BUS NO -->
    <div class="mb-4">
      <label class="form-label">Bus No (optional)</label>
      <input class="form-control" v-model="busNo" placeholder="WB-XX-1234">
    </div>

    <button class="btn btn-primary w-100" @click="search">
      <i class="bi bi-search"></i> Search
    </button>
  </div>
</div>

<script>
/* ---------- PHASER BACKGROUND ---------- */
new Phaser.Game({
  type: Phaser.AUTO,
  parent: 'phaser-bg',
  width: window.innerWidth,
  height: window.innerHeight,
  transparent:true,
  scene:{
    create(){
      for(let i=0;i<40;i++){
        let c=this.add.circle(
          Phaser.Math.Between(0,window.innerWidth),
          Phaser.Math.Between(0,window.innerHeight),
          Phaser.Math.Between(2,5),
          0x0d6efd,
          0.15
        );
        this.tweens.add({
          targets:c,
          y:'-=60',
          duration:4000,
          yoyo:true,
          repeat:-1,
          delay:i*80
        });
      }
    }
  }
});

/* ---------- VUE APP ---------- */
Vue.createApp({
  data(){
    return{
      from:'',
      to:'',
      busNo:'',
      stops:[],
      filteredStops:[],
      showFromOptions:false,
      showToOptions:false,
      fromNotFound:false,
      toNotFound:false
    }
  },
  mounted(){
    fetch('buses.json')
      .then(r=>r.json())
      .then(d=>{
        let set=new Set();
        d.buses.forEach(b=>b.stops.forEach(s=>set.add(s.name)));
        this.stops=[...set];
      });
  },
  methods:{
    filterStops(type){
      const val=(type==='from'?this.from:this.to).toLowerCase();
      if(val.length<2){
        this.showFromOptions=this.showToOptions=false;
        return;
      }
      this.filteredStops=this.stops.filter(s=>s.toLowerCase().includes(val));
      if(type==='from'){
        this.showFromOptions=true;
        this.fromNotFound=this.filteredStops.length===0;
      }else{
        this.showToOptions=true;
        this.toNotFound=this.filteredStops.length===0;
      }
    },
    selectStop(type,val){
      if(type==='from'){
        this.from=val;
        this.showFromOptions=false;
      }else{
        this.to=val;
        this.showToOptions=false;
      }
    },
    search(){
      if(this.busNo){
        location.href=`bus.html?busNo=${encodeURIComponent(this.busNo)}`;
      }else if(this.from && this.to){
        location.href=`results.html?from=${encodeURIComponent(this.from)}&to=${encodeURIComponent(this.to)}`;
      }
    }
  }
}).mount('#app');
</script>

</body>
</html>
