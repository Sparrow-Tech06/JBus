<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #ffffff; }
    .bus-card { 
      border-radius: 12px; 
      margin-bottom: 20px; 
      padding: 15px;
      border: 1px solid #008080;
    }
    .bus-image {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 10px;
    }
    .accordion-button:focus {
       outline: none !important;
       box-shadow: none !important;
       border-color: transparent !important;
    }
    
    /* Full screen modal styling */
    .fullscreen-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 1050;
      overflow-y: auto;
      display: none;
    }
    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #dee2e6;
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 1;
    }
    .modal-content {
      padding: 1.5rem;
    }
    .close-btn {
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
    }
    .route-list {
      list-style-type: none;
      padding-left: 0;
    }
    .route-list li {
      padding: 0.75rem 0;
      border-bottom: 1px solid #f1f1f1;
      display: flex;
      align-items: center;
    }
    .route-list li:last-child {
      border-bottom: none;
    }
    .time-badge {
      background-color: #008080;
      color: white;
      padding: 0.35rem 0.65rem;
      border-radius: 6px;
      margin-right: 1rem;
      min-width: 70px;
      text-align: center;
    }
    .current-stop {
      background-color: #e6f7f7;
      border-left: 4px solid #008080;
    }
  </style>
</head>
<body class="container py-4">

  <h3 class="mb-4 text-center">Available Buses</h3>
  <div id="results"></div>

  <!-- Full screen modal for route details -->
  <div id="routeModal" class="fullscreen-modal">
    <div class="modal-header">
      <h5 class="modal-title" id="modalTitle">Route Details</h5>
      <button type="button" class="close-btn" id="closeModal">&times;</button>
    </div>
    <div class="modal-content">
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const from = params.get("from");
    const to = params.get("to");
    let buses = [];

    // Get modal elements
    const routeModal = document.getElementById('routeModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const closeModal = document.getElementById('closeModal');

    // Function to open modal with bus route details
    function openRouteModal(bus, fromStop, toStop) {
      modalTitle.textContent = `${bus.name} (${bus.no}) - Route & Timings`;
      
      // Create content for modal
      modalBody.innerHTML = `
        <div class="d-flex align-items-center mb-4">
          <img src="${bus.image}" class="bus-image me-3" alt="Bus Image">
          <div>
            <h4>${bus.name} (${bus.no})</h4>
            <p class="mb-1"><strong>From:</strong> ${bus.from}</p>
            <p class="mb-1"><strong>To:</strong> ${bus.to}</p>
          </div>
        </div>
        
        <h5 class="mb-3">Route Stops & Timings</h5>
        <ul class="route-list">
          ${bus.stops.map((stop, index) => {
            const isFromStop = stop.name.toLowerCase() === from.toLowerCase();
            const isToStop = stop.name.toLowerCase() === to.toLowerCase();
            const isBetweenStops = index >= fromStop.index && index <= toStop.index;
            const isCurrent = isFromStop || isToStop || isBetweenStops;
            
            return `
              <li class="${isCurrent ? 'current-stop' : ''}">
                <span class="time-badge">${stop.time}</span>
                <span>${stop.name} ${isFromStop ? '(Departure)' : ''} ${isToStop ? '(Arrival)' : ''}</span>
              </li>
            `;
          }).join('')}
        </ul>
      `;
      
      // Show modal
      routeModal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    // Close modal function
    function closeRouteModal() {
      routeModal.style.display = 'none';
      document.body.style.overflow = 'auto'; // Re-enable scrolling
    }

    // Event listeners for modal
    closeModal.addEventListener('click', closeRouteModal);
    
    // Close modal when clicking outside content
    routeModal.addEventListener('click', function(e) {
      if (e.target === routeModal) {
        closeRouteModal();
      }
    });

    // Fetch bus data
    fetch("buses.json")
      .then(res => res.json())
      .then(data => {
        buses = data.buses;

        // Filter buses that include both stops in correct order
        buses = buses.filter(bus => {
          const stopNames = bus.stops.map(s => s.name.toLowerCase());
          const fromIndex = stopNames.indexOf(from.toLowerCase());
          const toIndex = stopNames.indexOf(to.toLowerCase());
          return fromIndex !== -1 && toIndex !== -1 && fromIndex < toIndex;
        });

        const resultsDiv = document.getElementById("results");
        if (buses.length === 0) {
          resultsDiv.innerHTML = `<p class="text-danger">No buses found for ${from} → ${to}</p>`;
          return;
        }

        resultsDiv.innerHTML = buses.map((bus, idx) => {
          // Find the from and to stops in this bus route
          const stopNames = bus.stops.map(s => s.name.toLowerCase());
          const fromIndex = stopNames.indexOf(from.toLowerCase());
          const toIndex = stopNames.indexOf(to.toLowerCase());
          
          const fromStop = { 
            index: fromIndex, 
            ...bus.stops[fromIndex] 
          };
          
          const toStop = { 
            index: toIndex, 
            ...bus.stops[toIndex] 
          };

          return `
            <div class="bus-card d-flex align-items-start gap-3">
              <img src="${bus.image}" class="bus-image" alt="Bus Image" draggable="false">
              
              <div class="flex-grow-1">
                <h5 class="mb-2">${bus.name} (${bus.no})</h5>
                <p class="mb-2"><strong>${bus.from}</strong> → <strong>${bus.to}</strong></p>
                <p class="mb-2 text-muted">Departure: ${fromStop.time} | Arrival: ${toStop.time}</p>

                <button class="btn btn-outline-primary mt-2 view-route-btn" data-bus-index="${idx}">
                  View Route & Timings
                </button>
              </div>
            </div>
          `;
        }).join("");

        // Add event listeners to all view route buttons
        document.querySelectorAll('.view-route-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const busIndex = parseInt(this.getAttribute('data-bus-index'));
            const bus = buses[busIndex];
            
            // Find the from and to stops in this bus route
            const stopNames = bus.stops.map(s => s.name.toLowerCase());
            const fromIndex = stopNames.indexOf(from.toLowerCase());
            const toIndex = stopNames.indexOf(to.toLowerCase());
            
            const fromStop = { 
              index: fromIndex, 
              ...bus.stops[fromIndex] 
            };
            
            const toStop = { 
              index: toIndex, 
              ...bus.stops[toIndex] 
            };
            
            openRouteModal(bus, fromStop, toStop);
          });
        });
      });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
